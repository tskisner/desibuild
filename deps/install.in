#!/bin/bash

# Install DESI dependencies from source.

mkdir -p @CONDA_ROOT@/bin
mkdir -p @CONDA_ROOT@/lib
mkdir -p @PREFIX@/lib/python3.5/site-packages

export PATH=@PREFIX@/bin:@CONDA_ROOT@/bin:${PATH}
export CPATH=@PREFIX@/include:${CPATH}
export LIBRARY_PATH=@PREFIX@/lib:${LIBRARY_PATH}
export LD_LIBRARY_PATH=@PREFIX@/lib:${LD_LIBRARY_PATH}
export PYTHONPATH=@PREFIX@/lib/python3.5/site-packages:${PYTHONPATH}

export ACCEPT_INTEL_PYTHON_EULA=yes

# Install conda root environment

@conda_root@

# Install conda packages.

@conda_pkgs@

conda list --export | grep -v conda > "@PREFIX@/pkg_list.txt"

# Install pip packages.

@pip_pkgs@

# Install mpi4py.

@mpi4py@

# Install CFITSIO.

@cfitsio@

# Install FFTW.

@fftw@

# Install BOOST.

@boost@

# Install HARP.

@harp@

# Compile python modules

python3 -m compileall -f "@CONDA_ROOT@/lib/python3.5/site-packages"
python3 -m compileall -f "@PREFIX@"

# Set permissions

if [ "x@CHGRP@" != "x" ]; then
    chgrp -R @CHGRP@ "@PREFIX@"
    chgrp -R @CHGRP@ "@CONDA_ROOT@"
fi

if [ "x@CHMOD@" != "x" ]; then
    chmod -R @CHMOD@ "@PREFIX@"
    chmod -R @CHMOD@ "@CONDA_ROOT@"
fi

# Install modulefile if the modulefiles directory is defined.

if [ "x@MODULE_DIR@" != "x" ]; then
    mkdir -p "@MODULE_DIR@/desiconda"
    cp "$0.module" "@MODULE_DIR@/desiconda/@MODULE_VERSION@"
    cp "$0.modversion" "@MODULE_DIR@/desiconda/.version_@MODULE_VERSION@"

    if [ "x@CHGRP@" != "x" ]; then
        chgrp -R @CHGRP@ "@MODULE_DIR@/desiconda"
    fi
    if [ "x@CHMOD@" != "x" ]; then
        chmod -R @CHMOD@ "@MODULE_DIR@/desiconda"
    fi
fi
